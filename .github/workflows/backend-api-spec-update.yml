name: Update backend api spec generated by Kotlin Gradle Plugin

on:
  pull_request:
    paths:
      - 'save-backend/**/*Controller*'

jobs:
  update_backend_api_spec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # Checkout source branch directly, without merging base into it
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
      - name: Install system packages
        # libcurl is needed for ktor-client-curl
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Generate open api doc
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          arguments: |
            :save-backend:generateOpenApiDocs
            -PgprUser=${{ github.actor }}
            -PgprKey=${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push if api spec is changed
        run: |
          git add save-backend/backend-api-docs.json
          if git diff --staged --quiet; then
            echo Everything is UP-TO-DATE
          else
            echo Pushing updated backend-api-docs.json
            git config user.name github-actions[bot]
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "Update backend-api-docs.json"
            git push
          fi
