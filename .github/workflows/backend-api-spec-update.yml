name: Update backend api spec generated by Kotlin Gradle Plugin

on:
  push:
    branches:
      - 'feature/update-api-workflow'
#  schedule:
#    # triggers the workflow every day at 5:30 UTC
#    - cron: '30 5 * * *'

jobs:
  update_backend_api_spec:
    runs-on: ubuntu-latest
    steps:
      - uses: peterjgrainger/action-create-branch@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'infra/update-backend-api-spec'

      - uses: actions/checkout@v3
        with:
          ref: infra/update-backend-api-spec

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
      - name: Install system packages
        # libcurl is needed for ktor-client-curl
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Generate open api doc
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          arguments: |
            :save-backend:generateOpenApiDocs
            -PgprUser=${{ github.actor }}
            -PgprKey=${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push if api spec is changed
        run: |
          touch tmpfile && git add tmpfile
          git add save-backend/backend-api-docs.json
          if git diff --staged --quiet; then
            echo Everything is UP-TO-DATE
          else
            echo Pushing updated backend-api-docs.json
            git config user.name github-actions[bot]
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "Update backend-api-docs.json"
            git push
          fi
