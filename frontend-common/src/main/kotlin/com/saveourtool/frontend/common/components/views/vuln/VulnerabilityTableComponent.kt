/**
 * View for vulnerability tables
 */

package com.saveourtool.frontend.common.components.views.vuln

import com.saveourtool.common.entities.cosv.VulnerabilityMetadataDtoWithUserAndOrganization
import com.saveourtool.common.entities.vulnerability.VulnerabilityStatus
import com.saveourtool.common.filters.VulnerabilityFilter
import com.saveourtool.common.frontend.TabMenuBar
import com.saveourtool.common.info.UserInfo
import com.saveourtool.common.validation.FrontendCosvRoutes
import com.saveourtool.frontend.common.components.basic.renderOrganizationWithName
import com.saveourtool.frontend.common.components.basic.renderUserAvatarWithName
import com.saveourtool.frontend.common.components.basic.table.filters.vulnerabilitiesFiltersRow
import com.saveourtool.frontend.common.components.tables.*
import com.saveourtool.frontend.common.externals.i18next.useTranslation
import com.saveourtool.frontend.common.themes.Colors
import com.saveourtool.frontend.common.utils.*
import com.saveourtool.frontend.common.utils.noopResponseHandler

import js.core.jso
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.td
import react.dom.html.ReactHTML.th
import react.dom.html.ReactHTML.tr
import react.router.dom.Link
import web.cssom.Border
import web.cssom.ClassName
import web.cssom.ColorProperty
import web.cssom.rem

import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json

private const val MAX_LEN_FOR_TEXT = 40
private const val SPLIT_INDEX = 25

/**
 * [FC] for [vulnerabilityTableComponent]
 */
val vulnerabilityTableComponent: FC<VulnerabilityTableComponentProps> = FC { props ->
    val (t, i18n) = useTranslation(TABLE_HEADERS_LOCALE_NAMESPACE)

    val isVulnerabilityCollectionPage = props.userName == null && props.organizationName == null
    val isUserProfilePage = props.userName != null
    val isOrganizationPage = props.organizationName != null

    val (selectedMenu, setSelectedMenu) = useState(VulnerabilityListTab.PUBLIC)

    /* Checking additional rights to show all vulnerabilities, not just public ones (that have status APPROVED or AUTO_APPROVED).
       Additional rights have:
       1) super admins to all vulnerabilities (on UserProfilePage and on OrganizationPage);
       2) users to their vulnerabilities (on UserProfilePage);
       3) users to organization vulnerabilities in which they have ADMIN role or higher (on OrganizationPage);
       It's assumed that on VulnerabilityCollectionPage the tabs availability is used to determine user access to functionality. */
    val isHasAdditionalRights: Boolean = props.currentUserInfo?.let { currentUserInfo ->
        currentUserInfo.globalRole?.let { role ->
            role.isSuperAdmin() || currentUserInfo.name == props.userName || props.isCurrentUserIsAdminInOrganization
        } ?: false
    } ?: false

    // don't show submitter on UserProfilePage and on VulnerabilityCollectionPage on owner tab (coz it's always current user)
    val isNeedToShowCosvSubmitter = !isUserProfilePage && selectedMenu != VulnerabilityListTab.OWNER
    // don't show organization on OrganizationPage
    val isNeedToShowOrganization = !isOrganizationPage
    // don't show status on VulnerabilityCollectionPage on public tab or if current user don`t have additional rights on UserProfilePage or OrganizationPage
    val isNeedToShowStatus = (!isVulnerabilityCollectionPage && isHasAdditionalRights) || selectedMenu != VulnerabilityListTab.PUBLIC

    val (vulnerabilityFilter, setVulnerabilityFilter) = useState {
        when {
            isVulnerabilityCollectionPage -> props.filters?.copy(statuses = listOf(VulnerabilityStatus.APPROVED, VulnerabilityStatus.AUTO_APPROVED)) ?: VulnerabilityFilter.approved
            isUserProfilePage -> when (isHasAdditionalRights) {
                true -> VulnerabilityFilter(authorName = props.userName)
                false -> VulnerabilityFilter.approved.copy(authorName = props.userName)
            }
            isOrganizationPage -> when (isHasAdditionalRights) {
                true -> VulnerabilityFilter(organizationName = props.organizationName)
                false -> VulnerabilityFilter.approved.copy(organizationName = props.organizationName)
            }
            else -> VulnerabilityFilter.empty
        }
    }
    val (countVulnerability, setCountVulnerability) = useState(0)

    val enrollRequest = useDeferredRequest {
        val count: Int = post(
            url = "$apiUrl/vulnerabilities/count/by-filter",
            headers = jsonHeaders,
            body = Json.encodeToString(vulnerabilityFilter),
            loadingHandler = ::noopLoadingHandler,
            responseHandler = ::noopResponseHandler,
        ).unsafeMap {
            it.decodeFromJsonString()
        }
        setCountVulnerability(count)
    }

    val vulnerabilityListTable: FC<VulnerabilityTableProps> = useMemo(isNeedToShowCosvSubmitter, isNeedToShowOrganization, isNeedToShowStatus, i18n.language) {
        tableComponent(
            columns = {
                columns {
                    column(id = "identifier", header = "Identifier".t(), { vulnerabilityMetadataDto.identifier }) { cellContext ->
                        Fragment.create {
                            td {
                                className = ClassName("align-middle text-nowrap")
                                div {
                                    className = ClassName("row m-0")
                                    Link {
                                        to = "/${FrontendCosvRoutes.VULNERABILITY_SINGLE}/${cellContext.row.original.vulnerabilityMetadataDto.identifier}"
                                        +cellContext.value
                                    }
                                }
                                div {
                                    className = ClassName("row m-0")
                                    cellContext.row.original.vulnerabilityMetadataDto.tags.forEach { tag ->
                                        div {
                                            className = ClassName("rounded-pill px-1 mt-1 mr-1")
                                            style = jso {
                                                fontSize = 0.8.rem
                                                color = Colors.VULN_PRIMARY.value.unsafeCast<ColorProperty>()
                                                border = "0.01rem solid $color".unsafeCast<Border>()
                                            }
                                            +tag
                                        }
                                    }
                                }
                            }
                        }
                    }
                    column(id = "summary", header = "Summary".t(), { vulnerabilityMetadataDto.summary }) { cellContext ->
                        Fragment.create {
                            td {
                                val vulnerabilityMetadataDto = cellContext.row.original.vulnerabilityMetadataDto
                                className = ClassName("align-middle")
                                +splitLongWordsInText(vulnerabilityMetadataDto.summary)
                            }
                        }
                    }
                    column(id = "severityNum", header = "Criticality".t(), { vulnerabilityMetadataDto.severityNum }) { cellContext ->
                        Fragment.create {
                            td {
                                val severityNum = cellContext.row.original.vulnerabilityMetadataDto.severityNum
                                val severityNumColor = when (severityNum) {
                                    in 0.0f..3.9f -> "text-success"
                                    in 3.9f..6.9f -> "text-warning"
                                    in 6.9f..10.0f -> "text-danger"
                                    else -> ""
                                }
                                className = ClassName("align-middle $severityNumColor text-center")
                                +(severityNum.toString())
                            }
                        }
                    }
                    column(id = "language", header = "Language".t(), { vulnerabilityMetadataDto.language }) { cellContext ->
                        Fragment.create {
                            td {
                                className = ClassName("align-middle text-center")
                                +"${cellContext.row.original.vulnerabilityMetadataDto.language}"
                            }
                        }
                    }
                    if (isNeedToShowCosvSubmitter) {
                        column(id = "user", header = "COSV Submitter".t(), { user.name }) { cellContext ->
                            Fragment.create {
                                td {
                                    className = ClassName("align-middle")
                                    cellContext.row.original.user.let { user ->
                                        renderUserAvatarWithName(user) {
                                            height = 2.rem
                                            width = 2.rem
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (isNeedToShowOrganization) {
                        column(id = "organization", header = "Organization".t(), { organization?.name }) { cellContext ->
                            Fragment.create {
                                td {
                                    className = ClassName("align-middle")
                                    cellContext.row.original.organization?.let { organization ->
                                        renderOrganizationWithName(organization) {
                                            height = 2.rem
                                            width = 2.rem
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (isNeedToShowStatus) {
                        column(id = "status", header = "Status".t(), { vulnerabilityMetadataDto.status }) { cellContext ->
                            Fragment.create {
                                td {
                                    val status = cellContext.row.original.vulnerabilityMetadataDto.status.value
                                    val statusColor = when (status) {
                                        "Approved" -> "text-success"
                                        "Created", "Edited" -> "text-warning"
                                        "Rejected" -> "text-danger"
                                        else -> ""
                                    }
                                    className = ClassName("align-middle $statusColor text-center text-nowrap")
                                    +status
                                }
                            }
                        }
                    }
                }
            },
            initialPageSize = if (isVulnerabilityCollectionPage) VULNERABILITIES_COLLECTION_TABLE_PAGE_SIZE else INITIAL_TABLE_PAGE_SIZE,
            useServerPaging = true,
            isTransparentGrid = true,
            tableOptionsCustomizer = { tableOptions ->
                enableExpanding(tableOptions)
            },
        ) {
            arrayOf(it.filters, it.count)
        }
    }

    if (isVulnerabilityCollectionPage) {
        props.currentUserInfo?.globalRole?.let { role ->
            val tabList = if (role.isSuperAdmin()) {
                VulnerabilityListTab.values().map { it.name }
            } else {
                VulnerabilityListTab.values().filter { it != VulnerabilityListTab.ADMIN }
                    .map { it.name }
            }
            tab(selectedMenu.name, tabList, "nav nav-tabs mt-3") { value ->
                setSelectedMenu { VulnerabilityListTab.valueOf(value) }
                setVulnerabilityFilter { getFiltersByTab(VulnerabilityListTab.valueOf(value), props.currentUserInfo) }
            }
        }
    }

    vulnerabilityListTable {
        filters = vulnerabilityFilter
        count = countVulnerability
        getData = { page, size ->
            post(
                url = "$apiUrl/vulnerabilities/by-filter",
                params = jso<dynamic> {
                    this.page = page
                    this.size = size
                },
                headers = jsonHeaders,
                body = Json.encodeToString(vulnerabilityFilter),
                loadingHandler = ::loadingHandler,
                responseHandler = ::noopResponseHandler,
            ).unsafeMap {
                it.decodeFromJsonString()
            }
        }
        getPageCount = { pageSize ->
            enrollRequest()
            pageCount(countVulnerability, pageSize)
        }
        commonHeaderBuilder = { cb, tableInstance, _ ->
            with(cb) {
                tr {
                    th {
                        colSpan = tableInstance.visibleColumnsCount()
                        vulnerabilitiesFiltersRow {
                            filter = vulnerabilityFilter
                            isNeedToFilterStatus = isNeedToShowStatus
                            onChangeFilter = { filterValue ->
                                filterValue?.let {
                                    setVulnerabilityFilter(filterValue)
                                } ?: run {
                                    setVulnerabilityFilter {
                                        when {
                                            isVulnerabilityCollectionPage -> getFiltersByTab(selectedMenu, props.currentUserInfo)
                                            isUserProfilePage -> when (isHasAdditionalRights) {
                                                true -> VulnerabilityFilter(authorName = props.userName)
                                                false -> VulnerabilityFilter.approved.copy(authorName = props.userName)
                                            }
                                            isOrganizationPage -> when (isHasAdditionalRights) {
                                                true -> VulnerabilityFilter(organizationName = props.organizationName)
                                                false -> VulnerabilityFilter.approved.copy(organizationName = props.organizationName)
                                            }
                                            else -> VulnerabilityFilter.empty
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

/**
 * Enum that contains values for vulnerability tab
 */
@Suppress("WRONG_DECLARATIONS_ORDER")
enum class VulnerabilityListTab {
    PUBLIC,
    ADMIN,
    OWNER,
    ;

    companion object : TabMenuBar<VulnerabilityListTab> {
        override val nameOfTheHeadUrlSection = ""
        override val defaultTab: VulnerabilityListTab = PUBLIC
        override val regexForUrlClassification = "https://cosv.gitlink.org.cn/${FrontendCosvRoutes.VULN}"
        override fun valueOf(elem: String): VulnerabilityListTab = VulnerabilityListTab.valueOf(elem)
        override fun values(): Array<VulnerabilityListTab> = entries.toTypedArray()
    }
}

/**
 * [TableProps] for vulnerabilities table
 */
external interface VulnerabilityTableProps : TableProps<VulnerabilityMetadataDtoWithUserAndOrganization> {
    /**
     * All filters in one value [filters]
     */
    var filters: VulnerabilityFilter?

    /**
     * Count of vulnerability
     */
    var count: Int?
}

/**
 * [Props] of vulnerability table view
 */
external interface VulnerabilityTableComponentProps : Props {
    /**
     * Current logged-in user
     */
    var currentUserInfo: UserInfo?

    /**
     * Name of user on user profile page
     */
    var userName: String?

    /**
     * Name of organization on organization page
     */
    var organizationName: String?

    /**
     * Flag that defines if current logged-in user is admin or higher of organization
     */
    var isCurrentUserIsAdminInOrganization: Boolean

    /**
     * All preset filters in one value [filters]
     */
    var filters: VulnerabilityFilter?
}

/**
 * @return [VulnerabilityFilter] depending on [VulnerabilityListTab]
 */
private fun getFiltersByTab(
    selectedMenu: VulnerabilityListTab,
    currentUserInfo: UserInfo?
) = when (selectedMenu) {
    VulnerabilityListTab.PUBLIC -> VulnerabilityFilter.approved
    VulnerabilityListTab.ADMIN -> VulnerabilityFilter.pendingApproval
    VulnerabilityListTab.OWNER -> VulnerabilityFilter(authorName = currentUserInfo?.name)
}

/**
 * @return the page count, using the [total] number of items and the [pageSize]
 *   items per page.
 */
private fun pageCount(total: Int, pageSize: Int): Int {
    require(total >= 0) {
        "total should be non-negative: $total"
    }
    require(pageSize > 0) {
        "pageSize should be positive: $pageSize"
    }

    /*-
     * Source: "Number Conversion" by Roland Backhouse
     * (http://www.cs.nott.ac.uk/~psarb2/G51MPC/slides/NumberLogic.pdf).
     *
     * This shouldn't be simplified: otherwise, if `total` is 0,
     * the page count of 1 would still be returned.
     */
    return (total + pageSize - 1) / pageSize
}

private fun splitLongWordsInText(text: String): String {
    val words = text.split(' ')
    return words.joinToString(" ") { word ->
        if (word.length > MAX_LEN_FOR_TEXT) {
            val sb = StringBuilder(word)
            sb.insert(SPLIT_INDEX, '\n')
            sb.toString()
        } else {
            word
        }
    }
}
