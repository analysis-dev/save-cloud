package com.saveourtool.save.cosv.service

import com.saveourtool.save.entities.Organization
import com.saveourtool.save.entities.User
import com.saveourtool.save.entitiescosv.VulnerabilityMetadata
import org.springframework.stereotype.Service
import org.springframework.transaction.annotation.Transactional

/**
 * Service for rating in vulnerability
 *
 * @param userService
 * @param organizationService
 */
@Service
class VulnerabilityRatingService(
    private val userService: UserService,
    private val organizationService: OrganizationService,
) {
    /**
     * @param vulnerabilityMetadata
     */
    @Transactional
    fun addRatingForManualUpload(vulnerabilityMetadata: VulnerabilityMetadata) {
        doAddRating(vulnerabilityMetadata.userId, MANUAL_UPLOAD_OWNER_RATING, vulnerabilityMetadata.organizationId, MANUAL_UPLOAD_ORGANIZATION_RATING)
    }

    /**
     * @param owner
     * @param organization
     * @param uploadedVulnerabilities
     */
    @Transactional
    fun addRatingForBulkUpload(owner: User, organization: Organization, uploadedVulnerabilities: Int) {
        doAddRating(owner, uploadedVulnerabilities * BULD_UPLOAD_OWNER_RATING, organization, uploadedVulnerabilities * BULD_UPLOAD_ORGANIZATION_RATING)
    }

    private fun doAddRating(
        owner: User,
        ownerRatingIncrement: Long,
        organization: Organization?,
        organizationRatingIncrement: Long,
    ) {
        userService.saveUser(owner.apply { rating += ownerRatingIncrement })
        organization?.let {
            organizationService.saveOrganization(organization.apply { rating += organizationRatingIncrement })
        }
    }

    private fun doAddRating(
        ownerId: Long,
        ownerRatingIncrement: Long,
        organizationId: Long?,
        organizationRatingIncrement: Long,
    ) {
        val owner = userService.findById(ownerId)
        userService.saveUser(owner.apply { rating += ownerRatingIncrement })
        val organization = organizationId?.let { organizationService.getOrganizationById(it) }
        organization?.let {
            organizationService.updateOrganization(organization.apply { rating += organizationRatingIncrement })
        }
    }

    companion object {
        private const val BULD_UPLOAD_ORGANIZATION_RATING = 1L
        private const val BULD_UPLOAD_OWNER_RATING = 1L
        private const val MANUAL_UPLOAD_ORGANIZATION_RATING = 10L
        private const val MANUAL_UPLOAD_OWNER_RATING = 10L
    }
}
