@file:Suppress(
    "FILE_NAME_INCORRECT",
    "FILE_NAME_MATCH_CLASS",
    "HEADER_MISSING_IN_NON_SINGLE_CLASS_FILE",
)

package com.saveourtool.save.frontend.components.views.vuln

import com.saveourtool.save.entities.cosv.VulnerabilityExt
import com.saveourtool.save.entities.vulnerability.VulnerabilityDateDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityDateType
import com.saveourtool.save.entities.vulnerability.VulnerabilityProjectDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityProjectType
import com.saveourtool.save.frontend.components.basic.carousel
import com.saveourtool.save.frontend.components.basic.timelineComponent
import com.saveourtool.save.frontend.components.modal.displayModal
import com.saveourtool.save.frontend.components.modal.mediumTransparentModalStyle
import com.saveourtool.save.frontend.components.tables.TableProps
import com.saveourtool.save.frontend.components.tables.columns
import com.saveourtool.save.frontend.components.tables.tableComponent
import com.saveourtool.save.frontend.components.tables.value
import com.saveourtool.save.frontend.externals.fontawesome.*
import com.saveourtool.save.frontend.externals.i18next.TranslationFunction
import com.saveourtool.save.frontend.externals.i18next.useTranslation
import com.saveourtool.save.frontend.utils.*
import com.saveourtool.save.info.UserInfo
import com.saveourtool.save.utils.asTimelineEntry
import com.saveourtool.save.utils.getTimeline
import com.saveourtool.save.utils.listToShortString

import com.saveourtool.osv4k.Affected
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.h4
import react.dom.html.ReactHTML.span
import react.dom.html.ReactHTML.td
import react.router.dom.Link
import web.cssom.*

import kotlinx.browser.window
import kotlinx.datetime.LocalDateTime
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.JsonObject

val vulnerabilityInfoTab: FC<VulnerabilityInfoTabProps> = FC { props ->
    val (t, i18n) = useTranslation("vulnerability")
    val dateWindowOpenness = useWindowOpenness()
    val deleteVulnerabilityWindowOpenness = useWindowOpenness()

    val (deleteProject, setDeleteProject) = useState<CosvAffected?>(null)

    // user can be able to edit the view only if he has rights and has pressed edit button
    val isAbleToEdit = hasRightsToEdit(props.currentUserInfo, props.vulnerability) && !props.isEditDisabled

    val (vulnerabilityProjects, setVulnerabilityProjects) = useStateFromProps(props.vulnerability.cosv.affected ?: emptyList())  // <List<VulnerabilityProjectDto>>(emptyList())

    val enrollRequest = useDeferredRequest {
        val response = post(
            url = "$apiUrl/vulnerabilities/save-projects",
            headers = jsonHeaders,
            body = Json.encodeToString(vulnerabilityProjects),
            loadingHandler = ::loadingHandler,
        )
        if (response.ok) {
            props.fetchVulnerability()
        }
    }

    val fetchProject: (VulnerabilityProjectDto) -> Unit = { project ->
        enrollRequest()
        props.addProjectWindowOpenness.closeWindow()
    }

    @Suppress("MISSING_KDOC_ON_FUNCTION")
    fun deleteProject() {
        deleteProject?.let {
            props.setVulnerability(
                props.vulnerability.copy(
                    cosv = props.vulnerability.cosv.copy(
                        affected = props.vulnerability.cosv.affected?.minus(deleteProject)
                    )
                )
            )

            setVulnerabilityProjects {
                it.minus(deleteProject)
            }
        }
        props.enrollRequest()
    }

    val (requestedType, setRequestedType) = useState<VulnerabilityProjectType?>(null)

    useEffect(requestedType) {
        requestedType?.let { props.addProjectWindowOpenness.openWindow() }
    }

    vulnerabilityProjectWindow {
        windowOpenness = props.addProjectWindowOpenness
        fetchProjectCredentials = fetchProject
        type = requestedType
        onClose = { setRequestedType(null) }
    }

    vulnerabilityDateModal {
        windowOpenness = dateWindowOpenness
        identifier = props.vulnerability.cosv.id
        onSuccess = props.fetchVulnerability
        this.vulnerability = props.vulnerability
        this.setVulnerability = props.setVulnerability
    }

    @Suppress("TYPE_ALIAS", "MAGIC_NUMBER", "UnusedPrivateProperty")
    val projectTable: FC<VulnerabilityTableProps> = useMemo(i18n.language) {
        tableComponent(
            columns = {
                columns {
                    column(id = "name", header = "Name".t(), { `package`?.name ?: "Undefined" }) { cellContext ->
                        Fragment.create {
                            td {
                                className = ClassName("align-middle")
                                cellContext.row.original.`package`?.repository.let { url ->
                                    if (url.isNullOrEmpty()) {
                                        +"${cellContext.row.original.`package`?.ecosystem ?: ""} (${cellContext.value})"
                                    } else {
                                        Link {
                                            to = url
                                            +"${cellContext.row.original.`package`?.ecosystem ?: ""} (${cellContext.value})"
                                        }
                                    }
                                }
                            }
                        }
                    }
                    column(id = "versions", header = "Versions".t(), { versions }) { cellContext ->
                        Fragment.create {
                            td {
                                className = ClassName("align-middle")
                                +cellContext.value.listToShortString()
                            }
                        }
                    }
                    column(id = "purl", header = "Purl".t(), { `package`?.purl ?: "Undefined" }) { cellContext ->
                        Fragment.create {
                            td {
                                className = ClassName("align-middle")
                                +cellContext.value
                            }
                        }
                    }
                    props.currentUserInfo?.let { userInfo ->
                        if (userInfo.isSuperAdmin() || userInfo.id == props.vulnerability.metadataDto.user.id) {
                            column("delete", "") { cellProps ->
                                Fragment.create {
                                    td {
                                        className = ClassName("align-middle")
                                        div {
                                            className = ClassName("d-flex justify-content-end")
                                            buttonBuilder(faTrashAlt, style = "") {
                                                setDeleteProject(value = cellProps.row.original)
                                                deleteVulnerabilityWindowOpenness.openWindow()
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            initialPageSize = 10,
            useServerPaging = false,
            isTransparentGrid = true,
        ) {
            arrayOf(it.projects)
        }
    }

    displayModal(
        deleteVulnerabilityWindowOpenness.isOpen(),
        "Delete project".t(),
        "Are you sure you want to remove this project?".t(),
        mediumTransparentModalStyle,
        deleteVulnerabilityWindowOpenness.closeWindowAction(),
    ) {
        buttonBuilder("Ok".t()) {
            deleteProject()
            deleteVulnerabilityWindowOpenness.closeWindow()
        }
        buttonBuilder("Close".t(), "secondary") {
            deleteVulnerabilityWindowOpenness.closeWindow()
        }
    }

    // this timeline is always shown as we always have at least creation date
    timelineComponent {
        this.vulnerability = props.vulnerability

        dates = props.vulnerability.cosv
            .getTimeline()
            .plus(
                VulnerabilityDateDto(
                    props.vulnerability.metadataDto.submitted,
                    VulnerabilityDateType.SUBMITTED_COSV,
                    props.vulnerability.cosv.id,
                )
            )

        onAddClick = { dateWindowOpenness.openWindow() }
            .takeIf { isAbleToEdit }

        onNodeClick = { date: LocalDateTime, type: String ->
            props.vulnerability.cosv.getTimeline()
                .find { it.type.value == type && it.date == date }
                ?.let { dateToDelete ->
                    if (window.confirm("Are you sure you want to delete a date?".t())) {
                        when (dateToDelete.type) {
                            VulnerabilityDateType.DISCLOSED, VulnerabilityDateType.FIXED, VulnerabilityDateType.FOUND, VulnerabilityDateType.INTRODUCED -> {
                                // FixMe: unify it with [[addThisDateToCosvTimeline]]

                                val newTimeline = this.vulnerability.cosv.timeline?.let {
                                    it - dateToDelete.asTimelineEntry()
                                }
                                props.setVulnerability(
                                    this.vulnerability.copy(
                                        cosv = this.vulnerability.cosv.copy(
                                            timeline = newTimeline
                                        )
                                    )
                                )
                            }

                            VulnerabilityDateType.WITHDRAWN -> props.setVulnerability(
                                props.vulnerability.copy(
                                    cosv = props.vulnerability.cosv.copy(
                                        withdrawn = null
                                    )
                                )
                            )

                            VulnerabilityDateType.PUBLISHED -> props.setVulnerability(
                                props.vulnerability.copy(
                                    cosv = props.vulnerability.cosv.copy(
                                        published = null
                                    )
                                )
                            )

                            else -> {

                            }
                        }
                    }
                }
                ?: Unit
        }
            .takeIf { isAbleToEdit }
    }

    @Suppress("COMPLEX_EXPRESSION")
    renderProjects(
        "Affected projects".t(),
        VulnerabilityProjectType.PROJECT,
        vulnerabilityProjects,
        projectTable,
        props.isTableView,
        isAbleToEdit,
        t,
    ) {
        setRequestedType(it)
    }
}

typealias CosvTableProps = TableProps<Affected<JsonObject, JsonObject, JsonObject>>
typealias CosvAffected = Affected<JsonObject, JsonObject, JsonObject>

/**
 * [Props] of vulnerability table
 */
external interface VulnerabilityTableProps : CosvTableProps {
    /**
     * Vulnerability projects
     */
    var projects: List<CosvAffected>
}

/**
 * [Props] of vulnerability info tab component
 */
external interface VulnerabilityInfoTabProps : Props {
    /**
     * Vulnerability dto of vulnerability: with cosv and metadata
     */
    var vulnerability: VulnerabilityExt

    /**
     * Vulnerability setter
     */
    var setVulnerability: StateSetter<VulnerabilityExt?>

    /**
     * Information about current user
     */
    var currentUserInfo: UserInfo?

    /**
     * Callback to update vulnerability
     */
    var fetchVulnerability: () -> Unit

    /**
     * view selection: table or carousel
     */
    var isTableView: Boolean

    /**
     * set state for the window where you can add project/commit/library
     */
    var addProjectWindowOpenness: WindowOpenness

    /**
     * If the edit button was not yet pressed
     */
    var isEditDisabled: Boolean

    /**
     * Setter for isEditDisabled
     */
    var setIsEditDisabled: StateSetter<Boolean>

    /**
     * Callback to update vulnerability
     */
    var enrollRequest: () -> Unit
}

@Suppress(
    "TYPE_ALIAS",
    "TOO_MANY_PARAMETERS",
    "LongParameterList",
    "IDENTIFIER_LENGTH"
)
private fun ChildrenBuilder.renderProjects(
    sectionName: String,
    projectType: VulnerabilityProjectType,
    projects: List<CosvAffected>,
    table: FC<VulnerabilityTableProps>,
    isTableView: Boolean,
    isAbleToEdit: Boolean,
    t: TranslationFunction,
    openProjectWindowFor: (VulnerabilityProjectType) -> Unit,
) {
    div {
        className = ClassName("mt-4")
        div {
            className = ClassName("mb-3 text-xs text-center font-weight-bold text-primary-blue text-uppercase")
            +sectionName
        }
        if (projects.isNotEmpty() && !isAbleToEdit) {
            if (isTableView) {
                div {
                    className = ClassName("mt-0 p-0")
                    table {
                        getData = { _, _ -> projects.toTypedArray() }
                        this.projects = projects
                        cardBodyClassName = "p-0 card"
                    }
                }
            } else {
                carousel(
                    projects.toList(),
                    "carousel",
                    outerClasses = "border border-secondary",
                ) {
                    renderProjectCard(it, t)
                }
            }
        } else {
            renderPlaceholder(false, "No information".t()) { openProjectWindowFor(projectType) }
        }
    }
}

@Suppress("IDENTIFIER_LENGTH")
private fun ChildrenBuilder.renderProjectCard(project: CosvAffected, t: TranslationFunction) {
    div {
        className = ClassName("card card-body")
        h4 {
            className = ClassName("text-center text-primary-blue mb-2")
            project.`package`?.repository.let { repositoryUrl ->
                if (repositoryUrl.isNullOrEmpty()) {
                    +"${project.`package`?.ecosystem} (${project.`package`?.name})"
                } else {
                    Link {
                        to = repositoryUrl
                        +"${project.`package`?.ecosystem} (${project.`package`?.name})"
                    }
                }
            }
        }
        span {
            className = ClassName("text-sm text-center mt-2 mb-3")
            val versionsCosv = project.versions ?: project.ranges?.flatMap { it.events }?.map { it.introduced }
            versionsCosv?.let {
                renderVersions(it)
            } ?: +"No version information".t()
        }
    }
}

private fun ChildrenBuilder.renderVersions(versions: List<String?>) {
    versions.filterNotNull().run {
        if (size <= 2) {
            forEach { span { +it } }
        } else {
            span { +first() }
            +" ... "
            span { +last() }
        }
    }
}

private fun ChildrenBuilder.renderPlaceholder(
    isAbleToEdit: Boolean,
    noInformationLabel: String,
    onClickFun: () -> Unit,
) {
    if (isAbleToEdit) {
        div {
            className = ClassName("d-flex justify-content-center vulnerability-placeholder")
            onClick = { onClickFun() }
            style = borderEditStyle(pointerCursor = true)
            fontAwesomeIcon(faPlus, "m-5", "lg")
        }
    } else {
        renderTablePlaceholder(borderStyleString = "dashed") { +noInformationLabel }
    }
}
