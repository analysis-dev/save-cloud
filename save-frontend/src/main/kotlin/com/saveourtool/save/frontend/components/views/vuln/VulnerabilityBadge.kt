@file:Suppress("FILE_NAME_MATCH_CLASS")

package com.saveourtool.save.frontend.components.views.vuln

import com.saveourtool.save.entities.vulnerability.VulnerabilityDto
import com.saveourtool.save.frontend.externals.progressbar.progressBar
import com.saveourtool.save.frontend.themes.Colors
import js.core.jso
import react.FC
import react.Props
import react.dom.html.ReactHTML.a
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.h4
import web.cssom.*
import web.cssom.TextDecoration.Companion.underline

private const val FOR_GREEN = 34
private const val FOR_YELLOW = 67
private const val MAX_VALUE = 100

val vulnerabilityBadge: FC<VulnerabilityBadgeProps> = FC { props ->
    val (color, criticalityLabel) = when (props.vulnerability.progress) {
        in 0..FOR_GREEN -> Colors.SUCCESS.value to "Low"
        in FOR_GREEN..FOR_YELLOW -> Colors.WARNING.value to "Moderate"
        in FOR_YELLOW..MAX_VALUE -> Colors.DANGER.value to "Critical"
        else -> throw IllegalStateException("Progress should be in [0; 100], got ${props.vulnerability.progress}")
    }
    div {
        className = ClassName("card shadow")
        style = jso {
            height = HEADER_HEIGHT.unsafeCast<Height>()
        }
        div {
            className = ClassName("card-body")
            div {
                className = ClassName("row")
                div {
                    className = ClassName("col-3 mr-1")
                    @Suppress("MAGIC_NUMBER", "MagicNumber")
                    div {
                        className = ClassName("row")
                        progressBar(props.vulnerability.progress, color = color, size = "6.5rem", lineWidth = "3.5rem")
                    }
                }
                div {
                    className = ClassName("col-6")
                    div {
                        className = ClassName("row align-items-center mb-2")
                        h4 {
                            className = ClassName("text-gray-900 mb-2")
                            +"Criticality Scoring"
                        }
                    }
                    div {
                        className = ClassName("row align-items-center mb-2")
                        div {
                            className = ClassName("text-center text-xs font-weight-bold text-uppercase p-1")
                            style = jso {
                                border = "0.1rem solid $color".unsafeCast<Border>()
                                borderRadius = "1rem".unsafeCast<BorderRadius>()
                                this.color = color.unsafeCast<ColorProperty>()
                            }
                            +criticalityLabel
                        }
                    }
                    div {
                        className = ClassName("row")
                        a {
                            className = ClassName("nav-link text-xs d-flex pl-0 active")
                            href = "https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator"
                            style = jso {
                                textDecoration = underline
                            }
                            +"NVD CVSS"
                        }
                    }
                }
            }
        }
    }
}

/**
 * [Props] of [vulnerabilityBadge]
 */
external interface VulnerabilityBadgeProps : Props {
    /**
     * [VulnerabilityDto] to display
     */
    var vulnerability: VulnerabilityDto

    /**
     * horizontal alignment
     */
    var horizontalAlignment: String
}
