@file:Suppress("FILE_NAME_INCORRECT", "FILE_NAME_MATCH_CLASS")

package com.saveourtool.save.frontend.components.views.fossgraph

import com.saveourtool.save.entities.vulnerability.VulnerabilityDateDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityProjectDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityProjectType
import com.saveourtool.save.frontend.components.basic.timelineComponent
import com.saveourtool.save.frontend.components.modal.displayModal
import com.saveourtool.save.frontend.components.modal.mediumTransparentModalStyle
import com.saveourtool.save.frontend.components.tables.TableProps
import com.saveourtool.save.frontend.components.tables.columns
import com.saveourtool.save.frontend.components.tables.tableComponent
import com.saveourtool.save.frontend.components.tables.value
import com.saveourtool.save.frontend.externals.fontawesome.faPlus
import com.saveourtool.save.frontend.externals.fontawesome.faTrashAlt
import com.saveourtool.save.frontend.externals.fontawesome.fontAwesomeIcon
import com.saveourtool.save.frontend.utils.*
import com.saveourtool.save.info.UserInfo
import com.saveourtool.save.utils.isNotNull

import js.core.jso
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.td
import react.router.dom.Link
import web.cssom.*

import kotlinx.datetime.LocalDateTime
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json

val vulnerabilityInfoTab: FC<VulnerabilityInfoTabProps> = FC { props ->
    val projectWindowOpenness = useWindowOpenness()
    val dateWindowOpenness = useWindowOpenness()
    val deleteVulnerabilityWindowOpenness = useWindowOpenness()

    val (deleteProject, setDeleteProject) = useState<VulnerabilityProjectDto?>(null)

    val isAbleToEdit = props.currentUserInfo.isSuperAdmin() || props.currentUserInfo?.id == props.vulnerability.userId

    val (vulnerabilityProjects, setVulnerabilityProjects) = useState<List<VulnerabilityProjectDto>>(emptyList())

    val enrollRequest = useDeferredRequest {
        val response = post(
            url = "$apiUrl/vulnerabilities/save-projects",
            headers = jsonHeaders,
            body = Json.encodeToString(vulnerabilityProjects),
            loadingHandler = ::loadingHandler,
        )
        if (response.ok) {
            props.fetchVulnerability()
        }
    }

    val fetchProject: (VulnerabilityProjectDto) -> Unit = { project ->
        setVulnerabilityProjects {
            it.plus(project.copy(vulnerabilityName = props.vulnerability.name))
        }
        enrollRequest()
        projectWindowOpenness.closeWindow()
    }

    val enrollDeleteProjectRequest = useDeferredRequest {
        deleteProject?.let { project ->
            val response = delete(
                url = "$apiUrl/vulnerabilities/delete-project?projectName=${project.name}&vulnerabilityName=${props.vulnerability.name}",
                headers = jsonHeaders,
                loadingHandler = ::loadingHandler,
            )
            if (response.ok) {
                props.fetchVulnerability()
            }
        }
    }

    val (dateToDelete, setDateToDelete) = useState<VulnerabilityDateDto?>(null)
    useRequest(arrayOf(dateToDelete)) {
        dateToDelete?.let { dateDto ->
            val response = post(
                url = "$apiUrl/vulnerabilities/delete-date",
                headers = jsonHeaders,
                body = Json.encodeToString(dateDto),
                loadingHandler = ::loadingHandler,
            )
            if (response.ok) {
                props.fetchVulnerability()
            }
        }
    }

    vulnerabilityProjectWindow {
        windowOpenness = projectWindowOpenness
        fetchProjectCredentials = fetchProject
    }
    vulnerabilityDateModal {
        windowOpenness = dateWindowOpenness
        vulnerabilityName = props.vulnerability.name
        onSuccess = props.fetchVulnerability
    }

    @Suppress(
        "TYPE_ALIAS",
        "MAGIC_NUMBER",
    )
    val projectTable: FC<TableProps<VulnerabilityProjectDto>> = tableComponent(
        columns = {
            columns {
                column(id = "name", header = "Name", { name }) { cellContext ->
                    Fragment.create {
                        td {
                            Link {
                                to = cellContext.row.original.url
                                +cellContext.value
                            }
                        }
                    }
                }
                column(id = "versions", header = "Versions", { versions }) { cellContext ->
                    Fragment.create {
                        td {
                            +cellContext.value
                        }
                    }
                }
                props.currentUserInfo?.let { userInfo ->
                    if (userInfo.isSuperAdmin() || userInfo.id == props.vulnerability.userId) {
                        column("delete", "") { cellProps ->
                            Fragment.create {
                                td {
                                    div {
                                        className = ClassName("d-flex justify-content-end")
                                        buttonBuilder(faTrashAlt, style = "") {
                                            setDeleteProject(value = cellProps.row.original)
                                            deleteVulnerabilityWindowOpenness.openWindow()
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        initialPageSize = 10,
        useServerPaging = false,
        isTransparentGrid = true,
    )

    displayModal(
        deleteVulnerabilityWindowOpenness.isOpen(),
        "Deletion of project",
        "Are you sure you want to remove this project?",
        mediumTransparentModalStyle,
        deleteVulnerabilityWindowOpenness.closeWindowAction(),
    ) {
        buttonBuilder("Ok") {
            enrollDeleteProjectRequest()
            deleteVulnerabilityWindowOpenness.closeWindow()
        }
        buttonBuilder("Close", "secondary") {
            deleteVulnerabilityWindowOpenness.closeWindow()
        }
    }

    props.currentUserInfo?.let {
        div {
            className = ClassName("d-flex justify-content-end my-2")
            buttonBuilder(faPlus, classes = "mr-2", isOutline = true, title = "Add more info") {
                projectWindowOpenness.openWindow()
            }
        }
    }

    if (props.vulnerability.dates.isNotEmpty()) {
        timelineComponent {
            dates = props.vulnerability.getDatesWithLabels()
            onAddClick = { dateWindowOpenness.openWindow() }
                .takeIf { props.currentUserInfo.isNotNull() }
            onNodeClick = { date: LocalDateTime, type: String ->
                props.vulnerability.dates
                    .find { it.type.value == type && it.date == date }
                    ?.let { setDateToDelete(it) }
                    ?: Unit
            }
                .takeIf { isAbleToEdit }
        }
    } else {
        renderPlaceholder(props.currentUserInfo) {
            dateWindowOpenness.openWindow()
        }
    }

    renderProjectTable(
        projectTable,
        props.vulnerability.projects.toSet(),
        "Affected libraries",
        VulnerabilityProjectType.LIBRARY,
        props.currentUserInfo,
    ) {
        projectWindowOpenness.openWindow()
    }

    renderProjectTable(
        projectTable,
        props.vulnerability.projects.toSet(),
        "Commits with fix",
        VulnerabilityProjectType.COMMIT,
        props.currentUserInfo,
    ) {
        projectWindowOpenness.openWindow()
    }

    renderProjectTable(
        projectTable,
        props.vulnerability.projects.toSet(),
        "Affected open source projects",
        VulnerabilityProjectType.PROJECT,
        props.currentUserInfo,
    ) {
        projectWindowOpenness.openWindow()
    }
}

/**
 * [Props] of vulnerability info tab component
 */
external interface VulnerabilityInfoTabProps : Props {
    /**
     * Vulnerability dto of vulnerability
     */
    var vulnerability: VulnerabilityDto

    /**
     * Information about current user
     */
    var currentUserInfo: UserInfo?

    /**
     * Callback to update vulnerability
     */
    var fetchVulnerability: () -> Unit
}

@Suppress("TYPE_ALIAS", "TOO_MANY_PARAMETERS", "LongParameterList")
private fun ChildrenBuilder.renderProjectTable(
    table: FC<TableProps<VulnerabilityProjectDto>>,
    projects: Set<VulnerabilityProjectDto>,
    tableName: String,
    projectType: VulnerabilityProjectType,
    currentUserInfo: UserInfo?,
    openProjectWindowFor: (VulnerabilityProjectType) -> Unit,
) {
    div {
        className = ClassName("mt-4")
        div {
            className = ClassName("mb-3 text-xs text-center font-weight-bold text-primary text-uppercase")
            +tableName
        }
        div {
            className = ClassName("card card-body mt-0 p-0")
            val data = projects.filter { it.type == projectType }.toTypedArray()
            if (data.isNotEmpty()) {
                table {
                    getData = { _, _ -> data }
                    cardBodyClassName = "p-0"
                }
            } else {
                renderPlaceholder(currentUserInfo) { openProjectWindowFor(projectType) }
            }
        }
    }
}

private fun ChildrenBuilder.renderPlaceholder(currentUserInfo: UserInfo?, onClickFun: () -> Unit) {
    currentUserInfo?.let {
        div {
            className = ClassName("d-flex justify-content-center")
            onClick = { onClickFun() }
            style = jso {
                cursor = "pointer".unsafeCast<Cursor>()
                borderStyle = "dashed".unsafeCast<BorderStyle>()
                borderWidth = "thin".unsafeCast<BorderWidth>()
            }
            fontAwesomeIcon(faPlus, "m-5", "lg")
        }
    } ?: div {
        className = ClassName("text-center p-5")
        +"Log in in order to edit vulnerabilities"
    }
}
