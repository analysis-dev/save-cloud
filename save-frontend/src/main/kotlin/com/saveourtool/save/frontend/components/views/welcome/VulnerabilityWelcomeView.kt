/**
 * A view related to the sign-in view
 */

@file:Suppress(
    "FILE_WILDCARD_IMPORTS",
    "WildcardImport",
    "MAGIC_NUMBER",
    "FILE_NAME_MATCH_CLASS"
)

package com.saveourtool.save.frontend.components.views.welcome

import com.saveourtool.save.frontend.components.views.welcome.pagers.vuln.renderVulnerabilityGeneralInfo
import com.saveourtool.save.frontend.externals.fontawesome.*
import com.saveourtool.save.frontend.themes.Colors
import com.saveourtool.save.frontend.utils.*
import com.saveourtool.save.info.OauthProviderInfo
import com.saveourtool.save.validation.FrontendRoutes

import js.core.jso
import org.w3c.fetch.Headers
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.main
import react.dom.html.ReactHTML.span
import web.cssom.*

import kotlinx.browser.window

val vulnWelcomeView: FC<WelcomeProps> = FC { props ->
    useBackground(Style.VULN_DARK)
    val (oauthProviders, setOauthProviders) = useState<List<OauthProviderInfo>>(emptyList())

    useRequest {
        val oauthProviderInfoList: List<OauthProviderInfo>? = get(
            "${window.location.origin}/sec/oauth-providers",
            Headers(),
            loadingHandler = ::loadingHandler,
            responseHandler = ::noopResponseHandler,
        ).run { if (ok) decodeFromJsonString() else null }
        oauthProviderInfoList?.let { setOauthProviders(it) }
    }

    main {
        className = ClassName("main-content mt-0 ps")
        div {
            className = ClassName("page-header align-items-start")
            style = jso {
                height = "100vh".unsafeCast<Height>()
                background = VULN_DARK_GRADIENT.unsafeCast<Background>()
                position = Position.relative
            }
            span {
                className = ClassName("mask bg-gradient-dark opacity-6")
            }

            particles()

            div {
                className = ClassName("row justify-content-center")

                // Sign-in header
                div {
                    className = ClassName("col-3 mr-4 mt-5")
                    div {
                        style = jso {
                            height = 30.rem
                        }
                        className = ClassName("card z-index-0")
                        // if user is not logged in - he needs to input credentials
                        props.userInfo?.let {
                            welcomeUserMenu(props.userInfo, Colors.VULN_PRIMARY) {
                                menuTextAndLink("Vulnerability database", FrontendRoutes.VULNERABILITIES, faCode)
                                hrNoMargin()
                                menuTextAndLink("Propose vulnerability", FrontendRoutes.CREATE_VULNERABILITY, faPlus)
                                hrNoMargin()
                                menuTextAndLink("Top rating", FrontendRoutes.VULN_TOP_RATING, faTrophy)
                            }
                        } ?: inputCredentialsView(oauthProviders, Colors.VULN_PRIMARY, "/${FrontendRoutes.VULNERABILITIES}")
                    }
                }

                div {
                    className = ClassName("col-6")
                    renderVulnerabilityGeneralInfo()
                }
            }
        }
    }
}
