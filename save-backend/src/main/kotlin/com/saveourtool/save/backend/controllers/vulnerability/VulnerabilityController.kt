package com.saveourtool.save.backend.controllers.vulnerability

import com.saveourtool.save.backend.service.vulnerability.VulnerabilityService
import com.saveourtool.save.configs.ApiSwaggerSupport
import com.saveourtool.save.entities.vulnerabilities.Vulnerability
import com.saveourtool.save.entities.vulnerability.VulnerabilityDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityProjectDto
import com.saveourtool.save.filters.VulnerabilityFilter
import com.saveourtool.save.utils.StringResponse
import com.saveourtool.save.utils.blockingToMono
import com.saveourtool.save.v1
import io.swagger.v3.oas.annotations.Operation
import io.swagger.v3.oas.annotations.responses.ApiResponse
import io.swagger.v3.oas.annotations.tags.Tag
import io.swagger.v3.oas.annotations.tags.Tags
import org.springframework.http.ResponseEntity
import org.springframework.web.bind.annotation.*
import reactor.core.publisher.Mono

typealias VulnerabilityDtoList = List<VulnerabilityDto>

/**
 * Controller for working with vulnerabilities.
 */
@ApiSwaggerSupport
@Tags(
    Tag(name = "vulnerabilities"),
)
@RestController
@RequestMapping(path = ["/api/$v1/vulnerabilities"])
class VulnerabilityController(
    private val vulnerabilityService: VulnerabilityService,
) {
    @PostMapping("/by-filters")
    @Operation(
        method = "POST",
        summary = "Get all vulnerabilities with filters.",
        description = "Get filtered vulnerabilities.",
    )
    @ApiResponse(responseCode = "200", description = "Successfully fetched all vulnerabilities by filters")
    fun getAllVulnerabilities(
        @RequestBody filters: VulnerabilityFilter,
    ): Mono<VulnerabilityDtoList> = blockingToMono {
        vulnerabilityService.getFiltered(filters).map(
            Vulnerability::toDto
        )
    }

    @GetMapping("/by-name-with-description")
    @Operation(
        method = "GET",
        summary = "Get vulnerability by name.",
        description = "Get vulnerability by name.",
    )
    @ApiResponse(responseCode = "200", description = "Successfully fetched vulnerability by name")
    fun getVulnerabilityWithDescriptionByName(
        @RequestParam name: String,
    ): Mono<VulnerabilityDto> = blockingToMono {
        vulnerabilityService.getVulnerabilityWithDescriptionByName(name)
    }

    @PostMapping("/save")
    @Operation(
        method = "POST",
        summary = "Save vulnerability.",
        description = "Save vulnerability.",
    )
    @ApiResponse(responseCode = "200", description = "Successfully saved vulnerability")
    fun save(
        @RequestBody vulnerabilityDto: VulnerabilityDto,
    ): Mono<StringResponse> = blockingToMono {
        vulnerabilityService.save(vulnerabilityDto)
    }.map {
        ResponseEntity.ok("Vulnerability was successfully saved")
    }

    @PostMapping("/save-projects")
    @Operation(
        method = "POST",
        summary = "Update vulnerability.",
        description = "Update vulnerability.",
    )
    @ApiResponse(responseCode = "200", description = "Successfully updated vulnerability")
    fun saveAllProjects(
        @RequestBody vulnerabilityDtos: List<VulnerabilityProjectDto>,
    ): Mono<StringResponse> = blockingToMono {
        vulnerabilityService.saveAllProjects(vulnerabilityDtos)
    }.map {
        ResponseEntity.ok("Vulnerability was successfully updated")
    }
}
